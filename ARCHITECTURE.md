# Siesco KPI - Архитектура проекта

## 1. Стек технологий
- **Backend:** PocketBase (Go v1.25+) - кастомная сборка, разделенная на модули.
- **Frontend:** Wails (React + TypeScript + Vite).
- **База данных:** SQLite (встроена в PocketBase) с использованием SQL View для сложной агрегации.

## 2. Структура Бэкенда (Модульность)
Код разделен на логические блоки для обеспечения поддерживаемости и тестируемости:

- **`main.go`**: Точка входа. Отвечает за инициализацию сервера, настройку `AppContext`, регистрацию маршрутов (routes), хуков (hooks) и запуск процесса миграции БД (`bootstrapCollections`).
- **`config.go`**: Содержит структуры данных (`AppConfig`, `StatusConfig`), константы имен коллекций/полей и структуру `AppContext` для внедрения зависимостей.
- **`handlers.go`**: Содержит функции-обработчики API. Вся логика приема запросов и формирования ответов сосредоточена здесь.
- **`helpers.go`**: Библиотека утилит. Включает парсинг JSON, валидацию дат, проверку статусов и "тяжелую" логику расчёта рейтингов.
- **`helpers_test.go`**: Unit-тесты для проверки корректности работы утилит.

## 3. Ключевые механизмы и оптимизации

### A. Внедрение зависимостей (`AppContext`)
В проекте отсутствуют глобальные переменные состояния. Все зависимости (база данных, карта типов статусов) передаются в обработчики через структуру `AppContext`. Это делает код предсказуемым и упрощает написание тестов.

### B. Оптимизация памяти (Streaming SQL)
Для формирования рейтингов (месячных и годовых) используется потоковая обработка данных. Вместо загрузки всех записей в оперативную память, сервер читает строки из БД по одной через `Rows.Next()`.
- **Результат:** Потребление памяти остается константным (O(1)) независимо от размера базы данных.

### C. Динамические статусы и поля
- **Источник истины:** `config.json`.
- **Типизация:** Статусы в конфиге имеют поле `"type": "final"`, `"in_progress"` или `"return"`. Бэкенд автоматически учитывает эти типы при расчете KPI и фильтрации.
- **Инициализация:** При первом запуске сервер сам создает необходимые коллекции и наполняет их данными из конфига.

### D. Безопасность и Валидация
- **Даты:** Все входящие даты проходят строгую проверку через `time.Parse`.
- **Права:** Доступ к API защищен проверкой ролей (`superadmin`, `is_coordinator`).
- **Целостность:** Реализована проверка существования записей и принадлежности к правильным коллекциям перед операциями записи.

### E. Пагинация
Эндпоинты списков (например, `actual-tasks`) поддерживают параметры `limit` и `offset`, что предотвращает перегрузку фронтенда при большом количестве задач.

## 4. Как запустить
1.  **Backend:** `go run . serve` (Автоматически подхватит все файлы пакета main).
2.  **Tests:** `go test ./...`
3.  **Frontend:** `wails dev`

## 5. База данных
- **Коллекции:** `tasks`, `users`, `statuses`, `task_fields`, `leave_requests`, `upload_logs`, `deletion_logs`.
- **View:** `monthly_user_stats` — используется для быстрой агрегации часов на уровне SQL.