# Siesco KPI - Архитектура проекта

## 1. Стек технологий
- **Backend:** PocketBase (Go v1.25+) - кастомная сборка, разделенная на модули.
- **Frontend:** Wails (React + TypeScript + Vite).
- **База данных:** SQLite (встроена в PocketBase) с использованием SQL View для сложной агрегации.

## 2. Структура Бэкенда (Модульность)
Код разделен на логические блоки для обеспечения поддерживаемости и тестируемости:

- **`main.go`**: Точка входа. Отвечает за инициализацию сервера, настройку `AppContext`, регистрацию маршрутов (routes), хуков (hooks) и запуск процесса миграции БД (`bootstrapCollections`).
- **`config.go`**: Содержит структуры данных (`AppConfig`, `StatusConfig`), константы имен коллекций/полей и структуру `AppContext` для внедрения зависимостей.
- **`handlers.go`**: Содержит функции-обработчики API. Вся логика приема запросов и формирования ответов сосредоточена здесь.
- **`helpers.go`**: Библиотека утилит. Включает парсинг JSON, валидацию дат, проверку статусов и "тяжелую" логику расчёта рейтингов.
- **`helpers_test.go`**: Unit-тесты для проверки корректности работы утилит.

## 3. Структура Фронтенда (React)
Фронтенд построен по принципу централизованного управления состоянием:

- **`SettingsContext.tsx`**: Глобальный контекст, который при старте загружает все справочники (статусы, поля задач) и следит за их актуальностью.
- **Real-time Sync**: Фронтенд подписан на изменения в PocketBase. При редактировании настроек в админ-панели, UI обновляется мгновенно у всех пользователей без перезагрузки страницы.
- **Локализация**: Языковые настройки (`ru`, `az`, `en`) управляются через контекст и доступны любому компоненту через хук `useSettings`.

## 4. Ключевые механизмы и оптимизации

### A. Внедрение зависимостей
В проекте отсутствуют глобальные переменные состояния как на бэкенде (`AppContext`), так и на фронтенде (`SettingsContext`). Это делает систему предсказуемой и легкой в отладке.

### B. Оптимизация памяти (Streaming SQL)
Для формирования рейтингов используется потоковая обработка данных на стороне Go. Сервер читает строки из БД по одной, что гарантирует стабильную работу при любом объеме данных.

### C. Динамические статусы и поля
- **Источник истины:** `config.json` на сервере.
- **Типизация:** Статусы имеют типы (`final`, `in_progress`), которые определяют логику KPI на бэкенде и фильтрацию на фронтенде.
- **Валидация Excel:** При загрузке отчетов фронтенд динамически проверяет соответствие колонок и значений текущим настройкам из БД.

### D. Безопасность
- Строгая валидация форматов дат на сервере.
- Проверка прав владения записями при редактировании.
- Изоляция бизнес-логики в хендлерах.

## 5. Как запустить
1.  **Backend:** `go run . serve`
2.  **Tests:** `go test ./...`
3.  **Frontend:** `wails dev`

## 6. База данных
- **Коллекции:** `tasks`, `users`, `statuses`, `task_fields`, `leave_requests`, `upload_logs`, `deletion_logs`.
- **View:** `monthly_user_stats` — используется для быстрой агрегации часов на уровне SQL.
